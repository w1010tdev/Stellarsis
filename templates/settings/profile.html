{% extends "base.html" %}
{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
{% endblock %}
{% block content %}
<div class="settings-layout">
    <aside class="settings-sidebar">
        <h3>设置</h3>
        <a href="{{ url_for('settings_index') }}">总览</a>
        <a href="{{ url_for('profile') }}" class="active">修改个人资料</a>
        <a href="{{ url_for('change_password') }}">修改密码</a>
        <a href="{{ url_for('settings_follows') }}">关注管理</a>
        <a href="{{ url_for('logout') }}" style="color:var(--danger-color);">退出登录</a>
    </aside>
    <section class="settings-main">
        <div class="profile-container settings-card">
            <h2>个人资料设置</h2>
            <div class="current-settings">
                <h3>当前设置预览</h3>
                <p>在聊天中，您的消息会显示为:</p>
                <div class="sample-text">
                    <span id="preview-wrap">
                        <span id="preview-badge" class="message-badge" style="display: inline-block; background-color: {{ current_user.color }}; color: white; {% if not current_user.badge %}display:none;{% endif %}">
                            {% if current_user.badge %}{{ current_user.badge }}{% endif %}
                        </span>
                        <span id="preview-name" style="color: {{ current_user.color }}; font-weight:600; margin-left:6px;">
                            {% if current_user.nickname %}{{ current_user.nickname }}{% else %}{{ current_user.username }}{% endif %}
                        </span>:
                    </span>
                    <span id="preview-sample-content">Ciallo～(∠・ω< )⌒☆</span>
                </div>
            </div>
            <form method="POST" action="{{ url_for('profile') }}">
                {{ form.hidden_tag() }}
                <div class="form-group">
                    {{ form.nickname.label }}
                    {{ form.nickname(class="form-control", id="nickname-input", placeholder="留空使用用户名") }}
                    {% for error in form.nickname.errors %}
                        <div class="error">{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="form-group">
                    {{ form.color.label }} (如 #FF0000)
                    <div style="display: flex; align-items: center; gap:8px;">
                        {{ form.color(class="form-control", type="text", id="color-input", placeholder="#000000") }}
                        <input id="color-picker" type="color" value="{{ current_user.color }}" style="width:40px;height:40px;padding:0;border-radius:6px;border:1px solid var(--border-color);" />
                    </div>
                    {% for error in form.color.errors %}
                        <div class="error">{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="form-group">
                    {{ form.badge.label }} (如 "VIP", 留空则不显示)
                    {{ form.badge(class="form-control", id="badge-input", placeholder="如: VIP, MOD") }}
                    {% for error in form.badge.errors %}
                        <div class="error">{{ error }}</div>
                    {% endfor %}
                </div>
                <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
                    <button type="submit" class="btn btn-primary">保存设置</button>
                    <a href="{{ url_for('change_password') }}" class="btn btn-secondary">修改密码</a>
                </div>
            </form>
        </div>
    </section>
</div>
<script>
    // 实时预览颜色选择
    document.addEventListener('DOMContentLoaded', function() {
        const colorInput = document.getElementById('color-input');
        const nicknameInput = document.getElementById('nickname-input') || document.querySelector('input[name="nickname"]');
        const badgeInput = document.getElementById('badge-input') || document.querySelector('input[name="badge"]');
        const previewName = document.getElementById('preview-name');
        const previewBadge = document.getElementById('preview-badge');
        const originalUsername = {{ current_user.username|tojson }};

        function sanitizeColor(val) {
            if (!val) return '';
            if (/^#([0-9a-fA-F]{3}){1,2}$/.test(val.trim())) return val.trim();
            return val.trim();
        }

        const colorPicker = document.getElementById('color-picker');

        function refreshPreview() {
            let name = originalUsername;
            if (nicknameInput && nicknameInput.value.trim()) {
                name = nicknameInput.value.trim();
            }
            if (previewName) previewName.textContent = name;

            if (badgeInput && badgeInput.value.trim()) {
                if (previewBadge) {
                    previewBadge.style.display = 'inline-block';
                    previewBadge.textContent = badgeInput.value.trim();
                }
            } else {
                if (previewBadge) previewBadge.style.display = 'none';
            }

            const colorVal = sanitizeColor(colorInput && colorInput.value ? colorInput.value : '{{ current_user.color }}');
            if (previewName) previewName.style.color = colorVal;
            if (previewBadge) previewBadge.style.backgroundColor = colorVal;
            try {
                if (colorPicker && colorVal && /^#([0-9a-fA-F]{3}){1,2}$/.test(colorVal)) {
                    if (colorPicker.value.toLowerCase() !== colorVal.toLowerCase()) colorPicker.value = colorVal;
                }
            } catch (e) { }
        }

        if (colorInput) colorInput.addEventListener('input', function () {
            const val = sanitizeColor(colorInput.value || '');
            if (colorPicker && /^#([0-9a-fA-F]{3}){1,2}$/.test(val)) try { colorPicker.value = val; } catch (e) { }
            refreshPreview();
        });
        if (colorPicker) colorPicker.addEventListener('input', function () {
            if (colorInput) colorInput.value = colorPicker.value;
            refreshPreview();
        });

        if (nicknameInput) nicknameInput.addEventListener('input', refreshPreview);
        if (badgeInput) badgeInput.addEventListener('input', refreshPreview);

        refreshPreview();
    });
</script>
{% endblock %}
