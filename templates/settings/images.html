{% extends "base.html" %}
{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
{% endblock %}
{% block content %}
<div class="settings-layout">
    <aside class="settings-sidebar">
        <h3>设置</h3>
        <a href="{{ url_for('settings_index') }}">总览</a>
        <a href="{{ url_for('profile') }}">修改个人资料</a>
        <a href="{{ url_for('settings_images') }}" class="active">{% if app_info.config.ENABLE_FILE_UPLOADS %}我的文件{% else %}我的图片{% endif %}</a>
        <a href="{{ url_for('change_password') }}">修改密码</a>
        <a href="{{ url_for('settings_follows') }}">关注管理</a>
        <a href="{{ url_for('logout') }}" style="color:var(--danger-color);">退出登录</a>
    </aside>
    <section class="settings-main">
        <div class="settings-card">
            <h2>{% if app_info.config.ENABLE_FILE_UPLOADS %}我的文件{% else %}我的图片{% endif %}</h2>
            <div id="quota-info" style="margin-bottom: 16px; padding: 12px; border-radius: 8px; background-color: var(--neutral-50); border: 1px solid var(--neutral-200);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span>图片配额：</span>
                    <span id="quota-text">加载中...</span>
                </div>
                <div style="width: 100%; height: 12px; background-color: var(--neutral-200); border-radius: 6px; overflow: hidden;">
                    <div id="quota-bar" style="height: 100%; width: 0%; background-color: var(--primary-500); transition: width 0.3s;"></div>
                </div>
            </div>
            <p>{% if app_info.config.ENABLE_FILE_UPLOADS %}此处列出您已上传的文件，您可以复制 Markdown 链接、插入到编辑器或删除文件。{% else %}此处列出您已上传的图片，您可以复制 Markdown 链接、插入到编辑器或删除图片。{% endif %}</p>
            <div style="display:flex;gap:12px;align-items:center;margin-top:12px;">
                <button id="images-upload-btn" class="btn btn-primary">{% if app_info.config.ENABLE_FILE_UPLOADS %}上传文件{% else %}上传图片{% endif %}</button>
                <input id="settings-images-input" type="file" accept="{% if app_info.config.ENABLE_FILE_UPLOADS %}*/*{% else %}image/*{% endif %}" style="display:none;" />
            </div>
            <div id="settings-images-list" style="margin-top:16px"></div>
        </div>
    </section>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/clipboard-polyfill.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/uploads.js') }}" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('images-upload-btn');
    var input = document.getElementById('settings-images-input');
    if (btn && input) {
        btn.addEventListener('click', function(){ input.click(); });
    }
    
    // 加载配额信息
    loadQuotaInfo();
});

function loadQuotaInfo() {
    fetch('/api/upload/quota', {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const quota = data.quota;
            const quotaText = document.getElementById('quota-text');
            const quotaBar = document.getElementById('quota-bar');
            
            if (quota.is_admin) {
                quotaText.textContent = '管理员 - 无限制';
                quotaBar.style.width = '0%';
            } else {
                const usedMB = (quota.used / (1024 * 1024)).toFixed(2);
                const totalMB = (quota.total / (1024 * 1024)).toFixed(2);
                const percent = quota.percent;
                
                quotaText.textContent = `${usedMB} MB / ${totalMB} MB (${percent.toFixed(1)}%)`;
                quotaBar.style.width = `${percent}%`;
            }
        } else {
            document.getElementById('quota-text').textContent = '加载失败';
        }
    })
    .catch(error => {
        console.error('加载配额信息失败:', error);
        document.getElementById('quota-text').textContent = '加载失败';
    });
}

// 定期更新配额信息（上传后）
document.addEventListener('uploadComplete', function() {
    setTimeout(loadQuotaInfo, 1000); // 上传完成后延迟更新
});
</script>
{% endblock %}
