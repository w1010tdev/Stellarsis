{% extends "base.html" %}
{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum.css') }}">
{% endblock %}
{% block content %}
    <div class="forum-container">
        <h1 class="section-title">贴吧</h1>
        {% if sections %}
        <!-- 使用响应式网格显示分区卡片 -->
        <div class="sections-grid">
        {% for section in sections %}
        {% set perm = section_permissions.get(section.id, 'Null') %}
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">{{ section.name }}</h2>
                <div class="section-actions">
                                <span class="perm-badge perm-{{ perm|lower() }}">{{ perm }}</span>
                                <span class="unread-badge" data-section-id="{{ section.id }}" title="未读" style="display:none"></span>
                    <a href="{{ url_for('forum_section', section_id=section.id) }}" class="view-all">进入</a>
                </div>
            </div>
            <p class="section-description">{{ section.description }}</p>
            <ul class="threads-list">
                {% set latest = section.threads|last %}
                {% if latest %}
                <li class="thread-item">
                    <h3 class="thread-title"><a href="{{ url_for('forum_thread', thread_id=latest.id) }}">{{ latest.title }}</a></h3>
                    <div class="thread-meta">
                        <span>作者: {{ latest.user.nickname or latest.user.username }}</span>
                        <span>时间: {{ latest.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                        <span>回复: {{ latest.replies.count() }}</span>
                    </div>
                    {% if latest.content %}
                    <div class="thread-content-preview">{{ latest.content[:120] }}{% if latest.content|length > 120 %}...{% endif %}</div>
                    {% endif %}
                </li>
                {% else %}
                <li class="thread-item empty">暂无帖子</li>
                {% endif %}
            </ul>
        </div>
        {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>暂无可访问的分区，请联系管理员以获取权限。</p>
        </div>
        {% endif %}
    </div>
    <script>
        // 填充贴吧未读数
        fetch('/api/last_views/unread_counts')
            .then(r => r.json())
            .then(data => {
                if (data && data.success) {
                    const forum = data.forum || {};
                    Object.keys(forum).forEach(id => {
                        const el = document.querySelector('.unread-badge[data-section-id="' + id + '"]');
                        if (el) {
                            const n = forum[id];
                            el.textContent = n > 0 ? n : '';
                            el.style.display = n > 0 ? 'inline-block' : 'none';
                        }
                    });
                }
            }).catch(e => console.error('获取未读数失败', e));
    </script>
{% endblock %}