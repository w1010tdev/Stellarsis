{% extends "base.html" %}
{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum.css') }}">
{% endblock %}
{% block content %}
    <div class="thread-container">
        <div class="thread-header">
            <h1 class="thread-title">{{ thread.title }}</h1>
            <div class="thread-user">
                {% if thread.user.badge %}
                <span class="user-badge" style="background-color:{{ thread.user.color }}; color: white;">{{ thread.user.badge }}</span>
                {% endif %}
                <span class="user-name" style="color:{{ thread.user.color }}">{{ thread.user.nickname or thread.user.username }}</span>
                <span class="thread-meta">{{ thread.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                {% if section_permission == 'su' or (section_permission == '777' and thread.user_id == current_user.id) or current_user.is_admin() %}
                <button class="btn delete-btn" style="margin-left:8px;" onclick="deleteThread({{ thread.id }}, '{{ thread.title|e }}')">删除帖子</button>
                {% endif %}
            </div>
        </div>
        <div class="thread-content">
            <script type="application/json" class="raw-content">{{ thread.content|tojson }}</script>
            <div class="rendered-content"><!-- 内容将由JS渲染 --></div>
        </div>
    </div>
    <div class="permission-banner perm-{{ section_permission|lower() }}">
        {% if section_permission == 'su' %}
        您拥有 su 权限，可管理该分区内所有内容。
        {% elif section_permission == '777' %}
        该分区允许发帖与回复。
        {% elif section_permission == '444' %}
        当前为 444 权限，仅可查看帖子与回复。
        {% endif %}
    </div>
    <div class="replies">
        <h2>回复 ({{ replies|length }})</h2>
        {% if forum_thread_total_pages and forum_thread_total_pages > 1 %}
        <div class="load-more-wrap" style="text-align:center;margin:8px 0;">
            <button id="load-more-btn" class="btn" data-current-page="{{ forum_thread_current_page }}" data-total-pages="{{ forum_thread_total_pages }}">加载更多</button>
        </div>
        {% endif %}
        {% for reply in replies %}
        <div class="reply" id="reply-{{ reply.id }}">
            <div class="reply-user">
                {% if reply.user.badge %}
                <span class="user-badge" style="background-color:{{ reply.user.color }}; color: white;">{{ reply.user.badge }}</span>
                {% endif %}
                <span class="user-name" style="color:{{ reply.user.color }}">{{ reply.user.nickname or reply.user.username }}</span>
                <span class="reply-time">{{ reply.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                {% if section_permission == 'su' or (section_permission == '777' and reply.user.id == current_user.id) %}
                <button class="btn delete-btn" onclick="deleteReply({{ reply.id }}, '{{ reply.user.username }}')">删除</button>
                {% endif %}
            </div>
            <div class="reply-content">
                <script type="application/json" class="raw-content">{{ reply.content|tojson }}</script>
                <div class="rendered-content"></div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% if can_reply %}
    <div class="reply-form-container">
        <h2>添加回复</h2>
        <form id="reply-form" data-thread-id="{{ thread.id }}">
            <div class="form-group">
                <textarea name="content" class="form-control" required placeholder="输入回复内容...（支持Markdown和LaTeX）"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">回复</button>
        </form>
    </div>
    {% else %}
    <div class="permission-hint">当前权限不允许回复。</div>
    {% endif %}
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 从元素中安全获取原始内容（优先 script.raw-content JSON）
            function getRawContent(el) {
                try {
                    const script = el.querySelector('script.raw-content');
                    if (script && script.textContent) {
                        // JSON.parse -> original string
                        try {
                            return JSON.parse(script.textContent);
                        } catch (e) {
                            // 不是 JSON 时返回原始文本
                            return script.textContent;
                        }
                    }
                    // Fallback: dataset.content
                    if (el.dataset && el.dataset.content) return el.dataset.content;
                } catch (e) {
                    console.error('获取原始内容失败:', e);
                }
                return '';
            }

            function renderInto(el, raw) {
                const container = el.querySelector('.rendered-content') || el;
                if (typeof window.renderContent === 'function') {
                    try {
                        container.innerHTML = window.renderContent(raw || '');
                        if (typeof window.postProcessRendered === 'function') window.postProcessRendered(container);
                        return;
                    } catch (e) {
                        console.error('渲染失败:', e);
                    }
                }
                // 降级显示为转义文本
                container.textContent = raw || '';
            }

            // 渲染帖子内容
            const threadEl = document.querySelector('.thread-content');
            if (threadEl) {
                const raw = getRawContent(threadEl);
                renderInto(threadEl, raw);
            }

            // 渲染回复
            document.querySelectorAll('.reply-content').forEach(replyEl => {
                const raw = getRawContent(replyEl);
                renderInto(replyEl, raw);
            });

            // 回复表单提交（不使用 alert，成功后直接刷新页面）
            const replyForm = document.getElementById('reply-form');
            function showFormMessage(text, isError) {
                let container = document.querySelector('.reply-form-container');
                if (!container) return;
                let msg = container.querySelector('.form-message');
                if (!msg) {
                    msg = document.createElement('div');
                    msg.className = 'form-message';
                    msg.style.margin = '8px 0';
                    container.insertBefore(msg, container.firstChild);
                }
                msg.textContent = text;
                msg.style.color = isError ? '#b00' : '#080';
                // 3秒后自动清除
                setTimeout(() => { if (msg && msg.parentNode) msg.parentNode.removeChild(msg); }, 3000);
            }

            if (replyForm) {
                replyForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const textarea = this.querySelector('textarea[name="content"]');
                    const content = textarea ? textarea.value : '';
                    const threadId = this.dataset.threadId || {{ thread.id }};

                    if (!content.trim()) {
                        showFormMessage('请输入回复内容', true);
                        return;
                    }
                    if (content.length > 5000) {
                        showFormMessage('回复内容不能超过5000个字符', true);
                        return;
                    }

                    const formData = new FormData();
                    formData.append('thread_id', threadId);
                    formData.append('content', content);

                    fetch('/api/forum/reply', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => { throw new Error(data.message || '请求失败'); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // 清空文本框并直接刷新页面以显示新回复
                            if (textarea) textarea.value = '';
                            window.location.reload();
                        } else {
                            throw new Error(data.message || '未知错误');
                        }
                    })
                    .catch(error => {
                        console.error('回复失败:', error);
                        showFormMessage('回复失败: ' + (error.message || ''), true);
                    });
                });
            }

            // 加载更多回复（向上翻页）
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function() {
                    const btn = this;
                    let cur = parseInt(btn.dataset.currentPage || '0', 10);
                    const total = parseInt(btn.dataset.totalPages || '1', 10);
                    if (cur >= total - 1) {
                        btn.style.display = 'none';
                        return;
                    }
                    const nextPage = cur + 1;
                    btn.disabled = true;
                    btn.textContent = '加载中...';
                    fetch(`/api/forum/thread/{{ thread.id }}/replies?page=${nextPage}`)
                    .then(r => { if (!r.ok) throw new Error('加载失败'); return r.json(); })
                    .then(data => {
                        if (data && data.success && Array.isArray(data.replies)) {
                            const container = document.querySelector('.replies');
                            const beforeEl = btn.parentNode;
                            data.replies.forEach(function(r) {
                                try {
                                    const div = document.createElement('div');
                                    div.className = 'reply';
                                    div.id = 'reply-' + r.id;
                                    let userHtml = '<div class="reply-user">';
                                    if (r.nickname || r.username) {
                                        userHtml += `<span class="user-name user-color-${r.color ? r.color.replace('#', '') : 'default'}">${escapeHtml(r.nickname||r.username||'')}</span>`;
                                    }
                                    userHtml += `<span class="reply-time">${escapeHtml(r.timestamp||'')}</span>`;
                                    userHtml += '</div>';
                                    const contentHtml = `<div class="reply-content"><script type="application/json" class="raw-content">${JSON.stringify(r.content||'')}<` + `/script><div class="rendered-content"></div></div>`;
                                    div.innerHTML = userHtml + contentHtml;
                                    container.insertBefore(div, beforeEl);
                                    try {
                                        const containerContent = div.querySelector('.rendered-content');
                                        if (typeof window.renderContent === 'function') {
                                            containerContent.innerHTML = window.renderContent(r.content || '');
                                            if (typeof window.postProcessRendered === 'function') window.postProcessRendered(containerContent);
                                        } else {
                                            containerContent.textContent = r.content || '';
                                        }
                                    } catch (e) { console.error('渲染新回复失败', e); }
                                } catch (e) { console.error('插入回复失败', e); }
                            });
                            btn.dataset.currentPage = nextPage;
                            if (nextPage >= total - 1) btn.style.display = 'none';
                        } else {
                            showToast('error', '加载失败');
                        }
                    })
                    .catch(err => { console.error('加载更多失败', err); showToast('error', '加载更多失败'); })
                    .finally(() => { btn.disabled = false; btn.textContent = '加载更多'; });
                });
            }

            // (forum intentionally does not auto-scroll on load)

            // 删除回复
            window.deleteReply = function(replyId, username) {
                if (!replyId) return;
                showConfirm(`确定要删除回复 ${username ? ('来自 ' + username) : ''}？此操作不可撤销。`, {danger: true})
                .then(function(confirmed) {
                    if (!confirmed) return;
                    fetch(`/api/forum/reply/${replyId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.success) {
                            const el = document.getElementById(`reply-${replyId}`);
                            if (el && el.parentNode) el.parentNode.removeChild(el);
                            showToast('success', data.message || '回复已删除');
                        } else {
                            showToast('error', '删除失败: ' + (data && data.message ? data.message : '未知错误'));
                        }
                    })
                    .catch(err => {
                        console.error('删除回复失败:', err);
                        showToast('error', '删除请求失败');
                    });
                });
            };

            // 删除主题帖（使用 DELETE 接口）
            window.deleteThread = function(threadId, title) {
                if (!threadId) return;
                showConfirm(`确定要删除主题帖 "${title || threadId}"？此操作不可撤销。`, {danger: true})
                .then(function(confirmed) {
                    if (!confirmed) return;
                    fetch(`/api/forum/thread/${threadId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.success) {
                            if (data.redirect) {
                                window.location = data.redirect;
                            } else {
                                showToast('success', data.message || '主题已删除');
                                // 若没有 redirect，则刷新页面
                                window.location.reload();
                            }
                        } else {
                            showToast('error', '删除失败: ' + (data && data.message ? data.message : '未知错误'));
                        }
                    })
                    .catch(err => {
                        console.error('删除主题失败:', err);
                        showToast('error', '删除请求失败');
                    });
                });
            };
        });

        // 监听渲染库加载完成：如果页面在库加载后仍需渲染，重新渲染
        document.addEventListener('renderReady', function() {
            document.querySelectorAll('.thread-content, .reply-content').forEach(element => {
                try {
                    // 通过上面定义的函数可用，因为它们在同一 script 块内
                    const script = element.querySelector && element.querySelector('script.raw-content');
                    let raw = '';
                    if (script && script.textContent) {
                        try { raw = JSON.parse(script.textContent); } catch (e) { raw = script.textContent; }
                    } else if (element.dataset && element.dataset.content) {
                        raw = element.dataset.content;
                    }
                    const container = element.querySelector('.rendered-content') || element;
                    if (typeof window.renderContent === 'function') {
                        container.innerHTML = window.renderContent(raw || '');
                    } else {
                        container.textContent = raw || '';
                    }
                } catch (e) {
                    console.error('延迟渲染失败:', e);
                }
            });
        });
    </script>
{% endblock %}