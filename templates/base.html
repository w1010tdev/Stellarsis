<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>群星议会</title>
    <!-- Theme preloader: apply critical vars quickly and load full theme CSS -->
    <script>
        (function () {
            try {
                var themeBase = "{{ url_for('static', filename='css/themes/') }}";
                var theme = null;
                try { theme = localStorage.getItem('theme'); } catch (e) { }
                // cookie fallback
                function getCookie(name) {
                    var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                    if (match) return decodeURIComponent(match[2]);
                    return null;
                }
                if (!theme) theme = getCookie('theme');
                // small set of critical variables to reduce flash
                var critical = {
                    light: {
                        '--surface-color': '#ffffff',
                        '--text-color': '#0f172a',
                        '--neutral-50': '#f8fafc',
                        '--background-image': 'linear-gradient(135deg,#f0f4ff 0%,#e6e9ff 100%)'
                    },
                    solarized: {
                        '--surface-color': '#fdf6e3',
                        '--text-color': '#073642',
                        '--neutral-50': '#fdf6e3',
                        '--background-image': 'linear-gradient(135deg,#fff8e6 0%,#f6ecd0 100%)'
                    },
                    purple: {
                        '--surface-color': '#0f0826',
                        '--text-color': '#efe6ff',
                        '--neutral-50': '#0b0716',
                        '--background-image': 'linear-gradient(135deg,#120427 0%,#2b0f4a 100%)'
                    }
                };
                if (theme && critical[theme]) {
                    var vars = critical[theme];
                    Object.keys(vars).forEach(function (k) {
                        document.documentElement.style.setProperty(k, vars[k]);
                    });
                    // attach full theme CSS (overrides all variables) for full styling
                    var link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.id = 'theme-full-css';
                    link.href = themeBase + theme + '.css';
                    document.head.appendChild(link);
                }
            } catch (e) {
                console.error('theme preloader error', e);
            }
        })();
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/alerts.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animations.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/command-palette.css') }}">
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
        crossorigin="anonymous">
    {% block additional_css %}{% endblock %}
    {% block head %}{% endblock %}
</head>

<body class="page-enter">
    <header>
        <div class="container">
            <h1><a href="/" id="global_title">群星议会</a></h1>
            <!-- 只在移动端显示的进入按钮 -->
            <button class="entry-button" id="entry-button">菜单</button>
            <nav id="main-nav" class="mobile-nav">
                <ul id="main-menu">
                    <li><a href="{{ url_for('chat_index') }}">即时聊天</a></li>
                    <li><a href="{{ url_for('forum_index') }}">贴吧</a></li>
                    {% if current_user.is_authenticated %}
                    <li><a href="{{ url_for('settings_index') }}">设置</a></li>
                    {% else %}
                    <li><a href="{{ url_for('login') }}">登录</a></li>
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.is_admin() %}
                    <li><a href="{{ url_for('admin_index') }}">管理面板</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </header>
    <main class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </main>
    <footer>
        <div class="container">
            <p>群星议会 &copy; 2025 | 在线人数: <span id="global-online-count">加载中...</span> |
            <a href="https://github.com/w1010tdev/stellarsis" target="_blank" style="display: inline-flex; align-items: center; text-decoration: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 4px;">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                GitHub
            </a>
            </p>
        </div>
    </footer>
    {% block scripts %}
    <!-- 引入 Cloudflare 的 clipboard 库 -->
    <script src="https://unpkg.com/clipboard-polyfill/dist/es5/window-var/clipboard-polyfill.window-var.promise.es5.js"></script>
    <script src="{{ url_for('static', filename='js/theme-switcher.js') }}"></script>
    <script src="{{ url_for('static', filename='js/command-palette.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
    <!-- highlight.js CSS & JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <!-- 汉堡菜单JS交互 -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const entryButton = document.getElementById('entry-button');

            // 绑定进入按钮点击事件
            if (entryButton) {
                entryButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // 仅在移动端处理
                    if (window.innerWidth > 768) return;

                    // 动态创建并显示菜单
                    createAndShowMobileMenu();
                });
            }

            function createAndShowMobileMenu() {
                // 如果菜单已经存在，则不再重复创建
                if (document.getElementById('menu-toggle')) return;

                // 1. 创建汉堡菜单按钮
                const menuToggle = document.createElement('button');
                menuToggle.className = 'menu-toggle';
                menuToggle.id = 'menu-toggle';
                menuToggle.innerHTML = '<span></span>';

                // 2. 创建导航菜单（如果不存在）
                let mainNav = document.getElementById('main-nav');
                if (!mainNav) {
                    mainNav = document.createElement('nav');
                    mainNav.id = 'main-nav';
                    mainNav.className = 'mobile-nav';
                    
                    const menuUl = document.createElement('ul');
                    menuUl.id = 'main-menu';
                    
                    // 添加菜单项
                    const menuItems = [];
                    menuItems.push({ text: '即时聊天', href: '{{ url_for("chat_index") }}' });
                    menuItems.push({ text: '贴吧', href: '{{ url_for("forum_index") }}' });
                    {% if current_user.is_authenticated %}
                    menuItems.push({ text: '设置', href: '{{ url_for("settings_index") }}' });
                    {% else %}
                    menuItems.push({ text: '登录', href: '{{ url_for("login") }}' });
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.is_admin() %}
                    menuItems.push({ text: '管理面板', href: '{{ url_for("admin_index") }}' });
                    {% endif %}
                    
                    menuItems.forEach(item => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = item.href;
                        a.textContent = item.text;
                        li.appendChild(a);
                        menuUl.appendChild(li);
                    });
                    
                    mainNav.appendChild(menuUl);
                }

                // 3. 创建背景覆盖层
                const navBackdrop = document.createElement('div');
                navBackdrop.className = 'nav-backdrop';
                navBackdrop.id = 'nav-backdrop';

                // 4. 将元素添加到DOM中
                document.body.appendChild(mainNav);
                document.body.appendChild(navBackdrop);
                
                const headerContainer = document.querySelector('header .container');
                headerContainer.insertBefore(menuToggle, document.querySelector('.entry-button'));

                // 5. 绑定菜单事件
                bindMenuEvents();

                // 6. 显示菜单
                setTimeout(() => {
                    mainNav.classList.add('show');
                    navBackdrop.classList.add('show');
                    menuToggle.classList.add('open');
                    document.body.style.overflow = 'hidden';
                }, 30);
            }

            function bindMenuEvents() {
                const menuToggle = document.getElementById('menu-toggle');
                const mainNav = document.getElementById('main-nav');
                const navBackdrop = document.getElementById('nav-backdrop');

                if (!menuToggle || !mainNav || !navBackdrop) return;

                // 关闭菜单函数
                function closeMenu() {
                    mainNav.classList.remove('show');
                    navBackdrop.classList.remove('show');
                    menuToggle.classList.remove('open');
                    document.body.style.overflow = '';

                    // 延迟删除元素，确保动画完成
                    setTimeout(() => {
                        if (menuToggle && menuToggle.parentNode) menuToggle.remove();
                        if (mainNav && mainNav.parentNode) mainNav.remove();
                        if (navBackdrop && navBackdrop.parentNode) navBackdrop.remove();
                    }, 300);
                }

                // 绑定点击事件
                menuToggle.addEventListener('click', closeMenu);
                navBackdrop.addEventListener('click', closeMenu);

                // 菜单项点击后关闭菜单
                const mainMenu = document.getElementById('main-menu');
                if (mainMenu) {
                    const menuLinks = mainMenu.querySelectorAll('a');
                    menuLinks.forEach(link => {
                        link.addEventListener('click', function () {
                            if (window.innerWidth <= 768) {
                                closeMenu();
                            }
                        });
                    });
                }

                // 窗口大小变化处理
                window.addEventListener('resize', function () {
                    if (window.innerWidth > 768) {
                        // 桌面端：移除动态元素
                        const toggleEl = document.getElementById('menu-toggle');
                        const navEl = document.getElementById('main-nav');
                        const backdropEl = document.getElementById('nav-backdrop');
                        
                        if (toggleEl) toggleEl.remove();
                        if (navEl) navEl.remove();
                        if (backdropEl) backdropEl.remove();
                        
                        document.body.style.overflow = '';
                    }
                });
            }
        });
    </script>

    <!-- 兼容性垫片 -->
    <script>
        // 基础ES5垫片
        if (!Array.prototype.includes) {
            Array.prototype.includes = function (searchElement) {
                return this.indexOf(searchElement) !== -1;
            };
        }
        // 确保Promise存在
        if (typeof Promise === 'undefined') {
            window.Promise = function (executor) {
                // 简单的Promise实现，仅用于兼容
                var callbacks = [];
                var value;
                var isResolved = false;
                function resolve(val) {
                    if (isResolved) return;
                    isResolved = true;
                    value = val;
                    callbacks.forEach(function (cb) { cb(val); });
                }
                try {
                    executor(resolve, function (reason) {
                        console.error("简易Promise拒绝:", reason);
                    });
                } catch (e) {
                    console.error("简易Promise执行错误:", e);
                }
                this.then = function (onFulfilled) {
                    return new Promise(function (resolve) {
                        function handleValue(val) {
                            var result = onFulfilled ? onFulfilled(val) : val;
                            resolve(result);
                        }
                        if (isResolved) {
                            setTimeout(function () { handleValue(value); }, 0);
                        } else {
                            callbacks.push(handleValue);
                        }
                    });
                };
            };
        }
        // 确保fetch存在
        if (typeof window.fetch === 'undefined') {
            window.fetch = function (url, options) {
                return new Promise(function (resolve, reject) {
                    var xhr = new XMLHttpRequest();
                    xhr.open(options && options.method ? options.method : 'GET', url, true);
                    xhr.onload = function () {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            resolve({
                                ok: true,
                                status: xhr.status,
                                statusText: xhr.statusText,
                                text: function () { return Promise.resolve(xhr.responseText); },
                                json: function () {
                                    try {
                                        return Promise.resolve(JSON.parse(xhr.responseText));
                                    } catch (e) {
                                        return Promise.reject(e);
                                    }
                                }
                            });
                        } else {
                            reject({
                                status: xhr.status,
                                statusText: xhr.statusText
                            });
                        }
                    };
                    xhr.onerror = function () {
                        reject({ status: 0, statusText: '网络错误' });
                    };
                    if (options && options.headers) {
                        for (var header in options.headers) {
                            xhr.setRequestHeader(header, options.headers[header]);
                        }
                    }
                    xhr.send(options && options.body ? options.body : null);
                });
            };
        }
    </script>
    <!-- 动态加载库的函数 -->
    <script>
        function loadScript(src, callback) {
            var script = document.createElement('script');
            script.src = src;
            script.async = false;  // 保持加载顺序
            script.onload = function () {
                console.log('已加载:', src);
                if (callback) callback();
            };
            script.onerror = function () {
                console.error('加载失败:', src);
                if (callback) callback(new Error('加载失败: ' + src));
            };
            document.head.appendChild(script);
        }
        function loadStylesheet(href) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = href;
            document.head.appendChild(link);
        }
        // 加载渲染库
        function loadRenderLibs(callback) {
            // 首先加载marked
            loadScript('https://fastly.jsdelivr.net/npm/marked@4.0.0/marked.min.js', function (err) {
                if (err) return callback(err);
                // 然后加载KaTeX JS
                loadScript('https://fastly.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js', function (err2) {
                    if (err2) return callback(err2);
                    // 也尝试提前加载 highlight.js（样式和脚本），以便 marked 能在渲染时高亮
                    try {
                        loadStylesheet('https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css');
                        loadScript('https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js', function () {
                            // 已加载所有渲染相关第三方库
                            callback();
                        });
                    } catch (e) {
                        // 若加载 highlight 失败也不阻塞渲染
                        callback();
                    }
                });
            });
        }
        // HTML转义函数
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        // 全局渲染函数
        window.renderContent = function (content) {
            try {
                // 1. 先用marked渲染Markdown
                // Configure marked to use highlight.js if available
                try {
                    if (typeof marked !== 'undefined') {
                        marked.setOptions({
                            gfm: true,
                            breaks: false,
                            highlight: function (code, lang) {
                                try {
                                    if (typeof hljs !== 'undefined' && hljs) {
                                        if (lang) {
                                            try { return hljs.highlight(code, { language: lang }).value; } catch (e) { return hljs.highlightAuto(code).value; }
                                        }
                                        return hljs.highlightAuto(code).value;
                                    }
                                } catch (ee) { }
                                return escapeHtml(code);
                            }
                        });
                    }
                } catch (e) { }

                let html = marked.parse(content);
                // 处理 @quote{123} 占位符为可被后处理识别的容器
                html = html.replace(/@quote\{(\d+)\}/g, function (m, id) {
                    return '<div class="quote" data-quote-id="' + id + '">引用的消息: #' + id + '（加载中）</div>';
                });
                // 2. 处理行内LaTeX: $...$
                html = html.replace(/\$([^\$]+)\$/g, function (match, p1) {
                    try {
                        return katex.renderToString(p1, {
                            throwOnError: false,
                            displayMode: false
                        });
                    } catch (e) {
                        console.warn('KaTeX渲染失败:', e.message);
                        return '<span class="katex-error">$' + escapeHtml(p1) + '$</span>';
                    }
                });
                // 3. 处理块级LaTeX: $$...$$
                html = html.replace(/\$\$([^\$]+)\$\$/g, function (match, p1) {
                    try {
                        return '<div class="katex-block">' +
                            katex.renderToString(p1, {
                                throwOnError: false,
                                displayMode: true
                            }) +
                            '</div>';
                    } catch (e) {
                        console.warn('KaTeX块级渲染失败:', e.message);
                        return '<div class="katex-block katex-error">$$' + escapeHtml(p1) + '$$</div>';
                    }
                });
                // 4. 处理行内LaTeX: \(...\)
                html = html.replace(/\\\((.*?)\\\)/g, function (match, p1) {
                    try {
                        return katex.renderToString(p1, {
                            throwOnError: false,
                            displayMode: false
                        });
                    } catch (e) {
                        console.warn('KaTeX渲染失败:', e.message);
                        return '<span class="katex-error">\\(' + escapeHtml(p1) + '\\)</span>';
                    }
                });
                // 5. 处理块级LaTeX: \[...\]
                html = html.replace(/\\\[(.*?)\\\]/g, function (match, p1) {
                    try {
                        return '<div class="katex-block">' +
                            katex.renderToString(p1, {
                                throwOnError: false,
                                displayMode: true
                            }) +
                            '</div>';
                    } catch (e) {
                        console.warn('KaTeX块级渲染失败:', e.message);
                        return '<div class="katex-block katex-error">\\[' + escapeHtml(p1) + '\\]</div>';
                    }
                });
                return html;
            } catch (e) {
                console.error('内容渲染失败:', e);
                // 降级：显示原始内容，但进行HTML转义
                return '<div class="render-error">' +
                    escapeHtml(content) +
                    '</div>';
            }
        };
        // 尝试加载渲染库
        loadRenderLibs(function (err) {
            if (err) {
                console.error('渲染库加载失败，将使用纯文本模式:', err);
                // 定义安全的纯文本渲染函数
                window.renderContent = function (content) {
                    return '<pre class="plaintext-render">' +
                        escapeHtml(content) +
                        '</pre>';
                };
            }
            // 触发自定义事件，通知页面渲染库已就绪
            var event = new Event('renderReady');
            document.dispatchEvent(event);
        });
        // 在渲染后对插入到 DOM 的内容进行后处理（如代码高亮）
        window.postProcessRendered = function (container) {
            try {
                if (!container || !(container instanceof Element)) return;
                function applyHighlight() {
                    try {
                        if (typeof hljs !== 'undefined' && hljs && typeof hljs.highlightElement === 'function') {
                            container.querySelectorAll('pre code').forEach(function (block) {
                                try { hljs.highlightElement(block); } catch (e) { /* ignore per-block errors */ }
                            });
                        }
                    } catch (e) {
                        console.error('代码高亮应用失败:', e);
                    }
                }

                // 如果 hljs 已经加载则直接应用，否则尝试动态加载（同时加载样式）
                if (typeof hljs !== 'undefined' && hljs && typeof hljs.highlightElement === 'function') {
                    applyHighlight();
                } else {
                    // 加载 highlight.js 样式与脚本（若尚未加载）
                    try {
                        loadStylesheet('https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css');
                        loadScript('https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js', function () {
                            // 有些高亮包需要注册语言，默认 core 包可以自动检测
                            setTimeout(applyHighlight, 30);
                        });
                    } catch (e) {
                        console.error('动态加载 highlight.js 失败:', e);
                    }
                }
                // 处理引用占位符：尝试找到已加载的回复节点或通过接口拉取
                try {
                    const quoteElements = container.querySelectorAll && container.querySelectorAll('.quote');
                    if (quoteElements && quoteElements.length > 0) {
                        let quoteCount = quoteElements.length;
                        const originalQuoteCount = quoteCount;
                        
                        quoteElements.forEach(function (qel) {
                            try {
                                const qid = qel.dataset && qel.dataset.quoteId;
                                if (!qid) {
                                    quoteCount--;
                                    return;
                                }
                                // 通过 API 拉取该回复（降级加载）
                                let apiaddr = '/api/chat/message/';
                                fetch(apiaddr + qid)
                                    .then(r => { if (!r.ok) throw new Error('加载引用失败'); return r.json(); })
                                    .then(data => {
                                        if (data && data.success && data.message) {
                                            const reply = data.message;
                                            const uname = reply.nickname || reply.username || ('用户' + (reply.user_id || ''));
                                            const rendered = (typeof window.renderContent === 'function') ? window.renderContent(reply.content || '') : escapeHtml(reply.content || '');
                                            qel.innerHTML = '<div class="quote-block"><div class="quote-header">引用来自：' + escapeHtml(uname) + '</div><div class="quote-content">' + rendered + '</div></div>';
                                            if (typeof window.postProcessRendered === 'function') window.postProcessRendered(qel);
                                        } else {
                                            qel.textContent = '引用的消息未知或已删除';
                                        }
                                    })
                                    .catch(err => { 
                                        qel.textContent = '引用加载失败'; 
                                    })
                                    .finally(() => {
                                        quoteCount--;
                                        // 当所有引用都处理完毕后，滚动到底部
                                        if (quoteCount <= 0) {
                                            setTimeout(() => {
                                                const chatContainer = document.getElementById('chat-messages');
                                                if (chatContainer) {
                                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                                }
                                            }, 100);
                                        }
                                    });

                            } catch (e) { 
                                console.error('处理引用失败', e); 
                                quoteCount--;
                                // 当所有引用都处理完毕后，滚动到底部
                                if (quoteCount <= 0) {
                                    setTimeout(() => {
                                        const chatContainer = document.getElementById('chat-messages');
                                        if (chatContainer) {
                                            chatContainer.scrollTop = chatContainer.scrollHeight;
                                        }
                                    }, 100);
                                }
                            }
                        });
                        
                        // 如果没有引用元素，也需要检查是否需要滚动
                        if (originalQuoteCount === 0) {
                            setTimeout(() => {
                                const chatContainer = document.getElementById('chat-messages');
                                if (chatContainer) {
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                }
                            }, 100);
                        }
                    }
                } catch (e) { console.error('引用后处理错误', e); }
            } catch (e) {
                console.error('postProcessRendered 错误:', e);
            }
        };
    </script>
    <!-- 全局在线人数更新 -->
    <script>
        // 添加socket.io加载状态跟踪
        document.globalSocketIoLoaded = false;
        document.globalSocketIoCallbacks = [];
        let heartbeatInterval;
        function startHeartbeat() {
            // 清除可能已存在的定时器
            if (heartbeatInterval) clearInterval(heartbeatInterval);

            heartbeatInterval = setInterval(() => {
                if (globalSocket && globalSocket.connected) {
                    globalSocket.emit('heartbeat');
                    console.log('已发送心跳');
                }
            }, 30000); // 30秒发送一次心跳
        }
        function onGlobalSocketIoLoaded() {
            document.globalSocketIoLoaded = true;
            document.globalSocketIoCallbacks.forEach(cb => cb());
            document.globalSocketIoCallbacks = [];
            startHeartbeat();
        }
        function waitForGlobalSocketIo(callback) {
            if (document.globalSocketIoLoaded) {
                callback();
            } else {
                document.globalSocketIoCallbacks.push(callback);
            }
        }
        // 确保socket.io加载
        if (typeof io === 'undefined') {
            var script = document.createElement('script');
            script.src = "{{ url_for('static', filename='js/vendor/socket.io.min.js') }}";
            script.onload = function () {
                onGlobalSocketIoLoaded();
            };
            script.onerror = function () {
                console.error('socket.io 加载失败');
                onGlobalSocketIoLoaded(); // 继续执行降级方案
            };
            document.head.appendChild(script);
        } else {
            onGlobalSocketIoLoaded();
        }
        // 全局变量
        let globalSocket = null;
        let globalOnlineCountInitialized = false;
        // 更新全局在线人数显示
        function updateGlobalOnlineCountDisplay(count) {
            const globalOnlineCountElement = document.getElementById('global-online-count');
            if (globalOnlineCountElement) {
                globalOnlineCountElement.textContent = count || '0';
            }
        }
        // 获取全局在线人数（WebSocket或fetch）
        function getGlobalOnlineCount() {

            // WebSocket不可用，使用fetch降级方案
            fetch('/api/online_count')
                .then(response => response.json())
                .then(data => {
                    updateGlobalOnlineCountDisplay(data.count);
                })
                .catch(error => {
                    console.error('获取全局在线人数失败:', error);
                    updateGlobalOnlineCountDisplay('错误');
                });

        }
        // 初始化全局在线人数更新
        function initializeGlobalOnlineCount() {
            if (globalOnlineCountInitialized) return; // 防止重复初始化
            globalOnlineCountInitialized = true;
            // 先获取一次全局在线人数
            getGlobalOnlineCount();
            // 设置定时器定期更新（当WebSocket不可用时）
            setInterval(() => {
                getGlobalOnlineCount();
                console.log('定时更新全局在线人数');
            }, 10000); // 每10s更新一次
        }
        // 设置WebSocket连接
        function setupGlobalSocket() {
            waitForGlobalSocketIo(function () {
                if (typeof io === 'undefined') {
                    console.log('socket.io 未加载，使用fetch降级方案');
                    initializeGlobalOnlineCount();
                    return;
                }
                try {
                    globalSocket = io('/', {
                        path: '/socket.io',
                        reconnection: true,
                        reconnectionAttempts: 5,
                        reconnectionDelay: 1000,
                        timeout: 20000,
                        transports: ['websocket', 'polling']
                    });
                    initializeGlobalOnlineCount();
                } catch (e) {
                    console.error('全局WebSocket初始化失败:', e);
                    initializeGlobalOnlineCount(); // 使用降级方案
                }
            });
        }
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function () {
            setupGlobalSocket();
        });
    </script>

    <script>
        // 页面入场：在 DOMContentLoaded 后触发 page-ready，产生约 0.45s 的平滑入场
        document.addEventListener('DOMContentLoaded', function () {
            // 使用 requestAnimationFrame 确保初始样式已应用
            requestAnimationFrame(function () {
                document.body.classList.add('page-ready');
            });
        });
    </script>
    {% endblock %}
</body>


</html>
