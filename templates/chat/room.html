{% extends "base.html" %}
{% block additional_css %}
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
  integrity="sha512-9us5+A5UKmXANWJ9W84/18XIZ6WZRqCJN+ZRQ5H2/0LZ2B5N5h+s5gIc7q083GxZm28qGzQ28lVn6N5NdY36g=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/chat.css') }}"
/>
{% endblock %} {% block content %}
<div id="online-list-modal" class="modal-backdrop">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">åœ¨çº¿ç”¨æˆ·</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <ul id="online-users-list"></ul>
    </div>
  </div>
</div>
<!-- éªŒè¯ç æ¨¡æ€æ¡†ï¼ˆç”±æœåŠ¡ç«¯è§¦å‘ require_captcha äº‹ä»¶æ˜¾ç¤ºï¼‰ -->
<div id="captcha-modal" class="modal-backdrop">
  <div class="modal-content small">
    <div class="modal-header">
      <h3 class="modal-title">è¯·è¾“å…¥éªŒè¯ç </h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="captcha-question" style="font-weight:600;margin-bottom:8px;"></div>
      <input id="captcha-answer" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" class="form-control" />
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end;">
        <button id="captcha-cancel" class="btn btn-outline">å–æ¶ˆ</button>
        <button id="captcha-submit" class="btn btn-primary">æäº¤</button>
      </div>
    </div>
  </div>
</div>
<div id="chat-container" data-permission="{{ room_permission }}">
  <div class="online-users">
    åœ¨çº¿äººæ•°: <span id="online-count">åŠ è½½ä¸­...</span>
    <button id="show-online-list" class="btn btn-secondary">
      æŸ¥çœ‹åœ¨çº¿åå•
    </button>
  </div>
  <div id="chat-messages"></div>
  <div class="chat-status" id="connection-status">è¿æ¥ä¸­...</div>
  <div
    id="message-input"
    class="{% if room_permission not in ['su', '777'] %}read-only{% endif %}"
  >
    <textarea
      id="message-text"
      placeholder="è¾“å…¥æ¶ˆæ¯...ï¼ˆæ”¯æŒMarkdownå’ŒLaTeXï¼‰"
      rows="2"
    ></textarea>
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
        <input id="chat-image-input" type="file" accept="image/*" class="form-control" style="display:none;" />
        <button id="chat-upload-btn" class="btn btn-outline" style="width:auto;padding:6px;">ğŸ“· ä¸Šä¼ </button>
        <div id="chat-image-list" style="flex:1"></div>
      </div>
    <button id="send-button" class="btn btn-primary">å‘é€</button>
  </div>
</div>

<!-- ç§»åŠ¨ç«¯å¿«é€Ÿæ‰“å¼€åœ¨çº¿åˆ—è¡¨æŒ‰é’® -->
<button
  id="show-online-list-mobile"
  class="mobile-online-btn"
  aria-label="åœ¨çº¿ç”¨æˆ·"
>
  ğŸ‘¥
</button>
<!-- ä¼ é€’æˆ¿é—´æ•°æ®ç»™JS -->
<script type="application/json" id="chat-room-data">
  {
      "room_id": {{ room.id }},
      "user_id": {{ current_user.id }},
      "username": "{{ current_user.username }}",
      "nickname": "{{ current_user.nickname or current_user.username }}",
      "color": "{{ current_user.color }}",
      "badge": "{{ current_user.badge }}",
      "permission": "{{ room_permission }}"
  }
</script>
{% endblock %} {% block scripts %} {{ super() }}
<!-- ç¡®ä¿socket.ioåŠ è½½ -->
<script>
  var global_title = document.getElementById("global_title");
  if (global_title) {
    global_title.innerText = "ç¾¤æ˜Ÿè®®ä¼š - "+" {{ room.name }} ";
  }
  //ç§»åŠ¨ç«¯éšè—footer
  if (window.innerWidth <= 768) {
    var footer = document.querySelector("footer");
    if (footer) {
      footer.style.display = "none";
    }
  }
  // æ·»åŠ socket.ioåŠ è½½çŠ¶æ€è·Ÿè¸ª
  document.chatIoLoaded = false;
  document.chatIoCallbacks = [];
  function onSocketIoLoaded() {
    document.chatIoLoaded = true;
    document.chatIoCallbacks.forEach((cb) => cb());
    document.chatIoCallbacks = [];
  }
  function waitForSocketIo(callback) {
    if (document.chatIoLoaded) {
      callback();
    } else {
      document.chatIoCallbacks.push(callback);
    }
  }
  // ç¡®ä¿socket.ioåŠ è½½
  if (typeof io === "undefined") {
    console.log("åŠ è½½ socket.io...");
    var script = document.createElement("script");
    script.src =
      "{{ url_for('static', filename='js/vendor/socket.io.min.js') }}";
    script.onload = function () {
      console.log("socket.io å·²åŠ è½½");
      onSocketIoLoaded();
    };
    script.onerror = function () {
      console.error("socket.io åŠ è½½å¤±è´¥");
      document.body.classList.add("no-websocket");
      onSocketIoLoaded(); // ç»§ç»­æ‰§è¡Œé™çº§æ–¹æ¡ˆ
    };
    document.head.appendChild(script);
  } else {
    onSocketIoLoaded();
  }
</script>
<!-- ç¡®ä¿ chat.js åœ¨ socket.io ä¹‹ååŠ è½½ -->
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<!-- åˆå§‹åŒ–èŠå¤© -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    waitForSocketIo(function () {
      console.log("å‡†å¤‡åˆå§‹åŒ–èŠå¤©ç³»ç»Ÿ");
      // ç­‰å¾…æ¸²æŸ“ç³»ç»Ÿå°±ç»ª
      function initWhenReady() {
        if (
          typeof window.renderContent === "function" &&
          typeof window.initChat === "function"
        ) {
          console.log("æ‰€æœ‰ä¾èµ–å·²å°±ç»ªï¼Œè°ƒç”¨ initChat");
          window.initChat();
        } else {
          console.log("ç­‰å¾…ä¾èµ–åŠ è½½...");
          setTimeout(initWhenReady, 500);
        }
      }
      initWhenReady();
    });
  });
</script>
<script src="{{ url_for('static', filename='js/uploads.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('chat-upload-btn');
    var input = document.getElementById('chat-image-input');
    if (btn && input) btn.addEventListener('click', function(e){ e.preventDefault(); input.click(); });
});
</script>
{% endblock %}
