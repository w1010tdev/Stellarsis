{% extends "base.html" %}
{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
{% endblock %}
{% block head %}
<title>{{ room.name }} - èŠå¤©å®¤</title>
{% endblock %}
{% block content %}
<div class="room-header">
    <h1>{{ room.name }}</h1>
    <p>{{ room.description }}</p>
</div>
<div class="permission-banner perm-{{ room_permission|lower() }}">
    {% if room_permission == 'su' %}
    æ‚¨æ‹¥æœ‰ su æƒé™ï¼Œå¯ä»¥æŸ¥çœ‹ã€å‘é€å¹¶åˆ é™¤è¯¥èŠå¤©å®¤å†…çš„æ‰€æœ‰æ¶ˆæ¯ã€‚
    {% elif room_permission == '777' %}
    æ‚¨æ‹¥æœ‰ 777 æƒé™ï¼Œå¯ä»¥æŸ¥çœ‹ã€å‘é€ï¼Œå¹¶åˆ é™¤è‡ªå·±åœ¨è¯¥èŠå¤©å®¤ä¸­çš„æ¶ˆæ¯ã€‚
    {% elif room_permission == '444' %}
    å½“å‰ä¸º 444 æƒé™ï¼Œä»…å¯æŸ¥çœ‹æ¶ˆæ¯ã€‚
    {% endif %}
</div>
<div class="online-users">
    åœ¨çº¿äººæ•°: <span id="online-count">åŠ è½½ä¸­...</span>
    <button id="show-online-list" class="btn btn-secondary">æŸ¥çœ‹åœ¨çº¿åå•</button>
</div>
<div id="online-list-modal" class="modal-backdrop">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">åœ¨çº¿ç”¨æˆ·</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <ul id="online-users-list"></ul>
        </div>
    </div>
</div>
<div id="chat-container" data-permission="{{ room_permission }}">
    <div id="chat-messages"></div>
    <div class="chat-status" id="connection-status">è¿æ¥ä¸­...</div>
    <div id="message-input" class="{% if room_permission not in ['su', '777'] %}read-only{% endif %}">
        <textarea id="message-text" placeholder="è¾“å…¥æ¶ˆæ¯...ï¼ˆæ”¯æŒMarkdownå’ŒLaTeXï¼‰" rows="2"></textarea>
        <button id="send-button" class="btn btn-primary">å‘é€</button>
    </div>
</div>

<!-- ç§»åŠ¨ç«¯å¿«é€Ÿæ‰“å¼€åœ¨çº¿åˆ—è¡¨æŒ‰é’® -->
<button id="show-online-list-mobile" class="mobile-online-btn" aria-label="åœ¨çº¿ç”¨æˆ·">ğŸ‘¥</button>
<!-- ä¼ é€’æˆ¿é—´æ•°æ®ç»™JS -->
<script type="application/json" id="chat-room-data">
        {
            "room_id": {{ room.id }},
            "user_id": {{ current_user.id }},
            "username": "{{ current_user.username }}",
            "nickname": "{{ current_user.nickname or current_user.username }}",
            "color": "{{ current_user.color }}",
            "badge": "{{ current_user.badge }}",
            "permission": "{{ room_permission }}"
        }
    </script>
{% endblock %}
{% block scripts %}
{{ super() }}
<!-- ç¡®ä¿socket.ioåŠ è½½ -->
<script>
    // æ·»åŠ socket.ioåŠ è½½çŠ¶æ€è·Ÿè¸ª
    document.chatIoLoaded = false;
    document.chatIoCallbacks = [];
    function onSocketIoLoaded() {
        document.chatIoLoaded = true;
        document.chatIoCallbacks.forEach(cb => cb());
        document.chatIoCallbacks = [];
    }
    function waitForSocketIo(callback) {
        if (document.chatIoLoaded) {
            callback();
        } else {
            document.chatIoCallbacks.push(callback);
        }
    }
    // ç¡®ä¿socket.ioåŠ è½½
    if (typeof io === 'undefined') {
        console.log('åŠ è½½ socket.io...');
        var script = document.createElement('script');
        script.src = "{{ url_for('static', filename='js/vendor/socket.io.min.js') }}";
        script.onload = function () {
            console.log('socket.io å·²åŠ è½½');
            onSocketIoLoaded();
        };
        script.onerror = function () {
            console.error('socket.io åŠ è½½å¤±è´¥');
            document.body.classList.add('no-websocket');
            onSocketIoLoaded(); // ç»§ç»­æ‰§è¡Œé™çº§æ–¹æ¡ˆ
        };
        document.head.appendChild(script);
    } else {
        onSocketIoLoaded();
    }
</script>
<!-- ç¡®ä¿ chat.js åœ¨ socket.io ä¹‹ååŠ è½½ -->
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<!-- åˆå§‹åŒ–èŠå¤© -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        waitForSocketIo(function () {
            console.log('å‡†å¤‡åˆå§‹åŒ–èŠå¤©ç³»ç»Ÿ');
            // ç­‰å¾…æ¸²æŸ“ç³»ç»Ÿå°±ç»ª
            function initWhenReady() {
                if (typeof window.renderContent === 'function' && typeof window.initChat === 'function') {
                    console.log('æ‰€æœ‰ä¾èµ–å·²å°±ç»ªï¼Œè°ƒç”¨ initChat');
                    window.initChat();
                } else {
                    console.log('ç­‰å¾…ä¾èµ–åŠ è½½...');
                    setTimeout(initWhenReady, 500);
                }
            }
            initWhenReady();
        });
    });
</script>
{% endblock %}