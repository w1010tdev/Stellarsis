{% extends "base.html" %}
{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat_rooms.css') }}">
{% endblock %}
{% block content %}
    <div class="rooms-container">
        <h1 class="section-title">聊天室</h1>
        {% if rooms %}
        <div class="rooms-grid">
            {% for room in rooms %}
            {% set perm = room_permissions.get(room.id, 'Null') %}
            <div class="room-card">
                <div class="room-card-header">
                    <h3>{{ room.name }}</h3>
                    <span class="perm-badge perm-{{ perm|lower() }}">{{ perm }}</span>
                    <span class="unread-badge" data-room-id="{{ room.id }}" title="未读消息" style="display:none"></span>
                </div>
                <p class="room-description">{{ room.description }}</p>
                <div class="room-actions">
                    <a href="{{ url_for('chat_room', room_id=room.id) }}" class="btn">进入</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>暂无可访问的聊天室，请联系管理员以获取权限。</p>
        </div>
        {% endif %}
    </div>
    <script>
        // 获取未读数并填充到房间卡
        fetch('/api/last_views/unread_counts')
            .then(r => r.json())
            .then(data => {
                if (data && data.success) {
                    const chat = data.chat || {};
                    Object.keys(chat).forEach(id => {
                        const el = document.querySelector('.unread-badge[data-room-id="' + id + '"]');
                        if (el) {
                            const n = chat[id];
                            el.textContent = n > 0 ? n : '';
                            el.style.display = n > 0 ? 'inline-block' : 'none';
                        }
                    });
                }
            }).catch(e => console.error('获取未读数失败', e));
    </script>
{% endblock %}