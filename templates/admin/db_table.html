{% extends "base.html" %}

{% block head %}<title>数据库管理 - 群星议会</title>{% endblock %}

{% block additional_css %}
<style>
    #editModal .modal-content {
        background-color: var(--surface-color, #ffffff) !important;
        color: var(--text-color, #333333) !important;
        position: relative;
        z-index: 10001;
        /* 确保高于所有元素 */
    }

    #editModal .modal-body {
        color: var(--text-color, #333333) !important;
        background-color: var(--surface-color, #ffffff) !important;
    }

    /* 2. 强制表单元素可见 */
    #editModal .form-group,
    #editModal .form-group label,
    #editModal .form-group input,
    #editModal .form-group textarea {
        color: var(--text-color, #333333) !important;
        background-color: var(--surface-color, #ffffff) !important;
        border-color: var(--card-border-color, #ddd) !important;
    }

    /* 3. 修复输入框聚焦状态 */
    #editModal input:focus,
    #editModal textarea:focus {
        border-color: var(--primary-color, #3b82f6) !important;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
    }

    /* 4. 确保模态框内容有最小高度 */
    #editModal .modal-body {
        min-height: 150px;
    }

    .db-table-container {
        padding: 20px;
        max-width: 100%;
        margin: 0 auto;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .table-header h2 {
        margin: 0;
        color: var(--on-surface);
    }

    .table-actions {
        display: flex;
        gap: 10px;
    }

    .table-info {
        margin-bottom: 20px;
        color: var(--muted-text-color);
    }

    .table-responsive {
        overflow-x: auto;
        margin-bottom: 20px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--surface-color);
        border: 1px solid var(--card-border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    .data-table th {
        background: var(--primary-color);
        color: var(--on-primary);
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }

    .data-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--card-border-color);
        word-break: break-all;
    }

    .data-table tr:last-child td {
        border-bottom: none;
    }

    .cell-editable {
        cursor: pointer;
    }

    .cell-editable:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .actions {
        white-space: nowrap;
    }

    .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
        margin-right: 5px;
    }

    .loading-indicator {
        text-align: center;
        padding: 20px;
        color: var(--muted-text-color);
    }

    .no-more-data {
        text-align: center;
        padding: 20px;
        color: var(--muted-text-color);
    }

    /* 修复模态框样式 - 关键修复 */
    .modal-backdrop {
        position: fixed;
        z-index: 100001 !important;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease;
    }

    .modal-backdrop.show {
        opacity: 1;
        visibility: visible;
    }

    /* 强制在show时显示 modal-content，覆盖全局样式防止被隐藏 */
    .modal-backdrop.show .modal-content {
        transform: scale(1) !important;
        opacity: 1 !important;
    }

    .modal-content {
        background-color: #ffffff !important;
        background-color: var(--surface-color, #ffffff) !important;
        margin: auto;
        padding: 0;
        border: 1px solid var(--card-border-color, #ddd);
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        z-index: 100002;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--card-border-color, #ddd);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        color: var(--on-surface);
    }

    .close {
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        color: var(--text-color);
    }

    .close:hover {
        color: var(--danger-500);
    }

    .modal-body {
        padding: 20px;
        min-height: 100px;
    }

    .form-actions {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .btn {
        display: inline-block;
        padding: 8px 16px;
        background: var(--primary-color);
        color: var(--on-primary);
        text-decoration: none;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }

    .btn:hover {
        background: var(--primary-700);
    }

    .btn-primary {
        background: var(--primary-color);
    }

    .btn-primary:hover {
        background: var(--primary-700);
    }

    .btn-secondary {
        background: var(--neutral-500);
    }

    .btn-secondary:hover {
        background: var(--neutral-600);
    }

    .btn-danger {
        background: var(--danger-500);
    }

    .btn-danger:hover {
        background: var(--danger-600);
    }

    /* 输入框样式 */
    input[type="text"],
    input[type="number"],
    textarea {
        width: 100%;
        padding: 8px 12px;
        margin: 5px 0;
        border: 1px solid var(--card-border-color);
        border-radius: 4px;
        background: var(--surface-color);
        color: var(--text-color);
        box-sizing: border-box;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    /* 修复悬停样式 - 使用主题变量 */
    .data-table tr:hover {
        background-color: var(--hover-bg, rgba(0, 0, 0, 0.05)) !important;
    }

    /* 添加主题变量支持 */
    :root {
        --hover-bg: rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] {
        --hover-bg: rgba(255, 255, 255, 0.03);
    }

    [data-theme="light"] {
        --hover-bg: rgba(0, 0, 0, 0.03);
    }

    /* 修复模态框表单样式 */
    .form-group {
        margin-bottom: 16px;
        position: relative;
        z-index: 10001;
    }

    .form-group label {
        display: block;
        margin: 8px 0 4px;
        color: var(--on-surface);
        font-weight: 500;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 8px;
        background: var(--surface-color);
        color: var(--text-color);
        border: 1px solid var(--card-border-color);
        border-radius: 4px;
    }

    /* 确保模态框内容可见 */
    #editModal .form-group,
    #editModal input {
        color: var(--text-color, #333) !important;
        background-color: var(--surface-color, #fff) !important;
        border-color: var(--card-border-color, #ddd) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="db-table-container">
    <div class="table-header">
        <h2>表: {{ table_name }}</h2>
        <div class="table-actions">
            <button class="btn btn-primary" onclick="loadMoreData()">加载更多</button>
        </div>
    </div>

    <div class="table-info">
        <p>显示前50条记录，按ID降序排列</p>
    </div>

    <div class="table-responsive">
        <table class="data-table" id="dataTable">
            <thead>
                <tr>
                    {% for col in columns %}
                    <th>{{ col }}</th>
                    {% endfor %}
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for row in rows %}
                <tr data-id="{{ row[0] }}"> <!-- 假设第一列是ID -->
                    {% for cell in row %}
                    <td class="cell-editable" data-column="{{ columns[loop.index0] }}">{{ cell|e }}</td>
                    {% endfor %}
                    <td class="actions">
                        <button class="btn btn-sm btn-primary" onclick="editRow(this)">编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRow(this)">删除</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="loading-indicator" id="loadingIndicator" style="display: none;">
        <p>加载中...</p>
    </div>

    <div class="no-more-data" id="noMoreData" style="display: none;">
        <p>没有更多数据</p>
    </div>
</div>

<!-- 编辑模态框 - 修复z-index和定位 -->
    <div class="modal-backdrop" id="editModal" style="display: none; z-index: 100001;">
    <div class="modal-content" style="z-index: 100002;">
        <div class="modal-header">
            <h3>编辑记录</h3>
            <span class="close modal-close" onclick="closeModal()" style="color: var(--text-color, #333);">&times;</span>
        </div>
        <div class="modal-body" style="color: var(--text-color, #333);">
            <form id="editForm">
                <input type="hidden" id="editRecordId" name="id">
                <div id="editFields" style="color: var(--text-color, #333);">
                    <!-- 动态内容将插入到这里 -->
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // 存储列名和主键信息 - 关键修复
    const TABLE_COLUMNS = {{ columns | tojson }};
    const PRIMARY_KEY = "{{ primary_key or 'id' }}";

    let offset = 50; // 从第50条开始加载
    let isLoading = false;
    let hasMoreData = true;

    // 加载更多数据
    function loadMoreData() {
        if (isLoading || !hasMoreData) return;

        isLoading = true;
        document.getElementById('loadingIndicator').style.display = 'block';

        fetch(`/admin/db/table/{{ table_name }}/data?offset=${offset}&limit=50`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tableBody = document.getElementById('tableBody');

                    if (data.data.length === 0) {
                        hasMoreData = false;
                        document.getElementById('loadingIndicator').style.display = 'none';
                        document.getElementById('noMoreData').style.display = 'block';
                        return;
                    }

                    data.data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-id', row[PRIMARY_KEY]);

                        // 生成表格行
                        TABLE_COLUMNS.forEach(col => {
                            const td = document.createElement('td');
                            td.className = 'cell-editable';
                            td.setAttribute('data-column', col);
                            td.textContent = row[col] !== null ? row[col] : 'NULL';
                            tr.appendChild(td);
                        });

                        // 添加操作列
                        const actionsTd = document.createElement('td');
                        actionsTd.className = 'actions';
                        actionsTd.innerHTML = `
                        <button class="btn btn-sm btn-primary" onclick="editRow(this)">编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRow(this)">删除</button>
                    `;
                        tr.appendChild(actionsTd);

                        tableBody.appendChild(tr);
                    });

                    offset += 50;
                } else {
                    alert('加载数据失败: ' + (data.message || '未知错误'));
                }

                document.getElementById('loadingIndicator').style.display = 'none';
                isLoading = false;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                isLoading = false;
                alert('加载数据时发生错误');
            });
    }

    // 修复编辑行 - 关键修复：正确获取单元格数据
    function editRow(button) {
        const row = button.closest('tr');
        const recordId = row.getAttribute('data-id');
        const editFieldsContainer = document.getElementById('editFields');
        
        // 清空容器
        editFieldsContainer.innerHTML = '';
        
        // 获取所有可编辑列（排除主键和操作列）
        const editableColumns = TABLE_COLUMNS.filter(col => col !== PRIMARY_KEY && col.toLowerCase() !== 'actions');
        
        editableColumns.forEach(colName => {
            const cell = row.querySelector(`td[data-column="${colName}"]`);
            const rawValue = cell ? cell.textContent : '';
            // 安全处理值（避免NULL显示和特殊字符）
            const value = (rawValue === 'NULL' || rawValue === 'null') ? '' : rawValue;
            
            // 安全创建DOM元素（避免innerHTML注入问题）
            const div = document.createElement('div');
            div.className = 'form-group';
            
            const label = document.createElement('label');
            label.htmlFor = `field_${colName}`;
            label.textContent = `${colName}:`;
            label.style.color = 'var(--text-color, #333)';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.id = `field_${colName}`;
            input.name = colName;
            input.value = value;
            input.style.color = 'var(--text-color, #333)';
            input.style.backgroundColor = 'var(--surface-color, #fff)';
            input.style.borderColor = 'var(--card-border-color, #ddd)';
            
            div.appendChild(label);
            div.appendChild(input);
            editFieldsContainer.appendChild(div);
        });

        // 设置记录ID
        document.getElementById('editRecordId').value = recordId;
        
        // 显示模态框
        const modal = document.getElementById('editModal');
        modal.style.display = 'flex';
        modal.style.opacity = '0';
        
        // 强制重绘
        setTimeout(() => {
            modal.style.opacity = '1';
            modal.classList.add('show');
            
            // 聚焦第一个输入框
            const firstInput = modal.querySelector('input[type="text"]');
            if (firstInput) firstInput.focus();
        }, 10);
    }
    // 删除行
    function deleteRow(button) {
        if (!confirm('确定要删除这条记录吗？此操作不可撤销。')) {
            return;
        }

        const row = button.closest('tr');
        const recordId = row.getAttribute('data-id');

        fetch(`/admin/db/table/{{ table_name }}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: recordId
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    row.remove();
                    alert('记录删除成功');
                } else {
                    alert('删除失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除时发生错误');
            });
    }

    // 关闭模态框 - 增强处理
    function closeModal() {
        const modal = document.getElementById('editModal');
        modal.classList.remove('show');

        // 等待过渡动画完成后隐藏
        setTimeout(() => {
            modal.style.display = 'none';
            // 清空表单内容防止残留
            document.getElementById('editFields').innerHTML = '';
        }, 200);
    }

    // 保存编辑
    document.getElementById('editForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const recordId = document.getElementById('editRecordId').value;

        const data = { id: recordId };
        for (let [key, value] of formData.entries()) {
            if (key !== 'id') {
                data[key] = value;
            }
        }

        fetch(`/admin/db/table/{{ table_name }}/edit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // 更新表格中的数据
                    const row = document.querySelector(`tr[data-id="${recordId}"]`);
                    if (row) {
                        TABLE_COLUMNS.forEach(colName => {
                            if (colName !== PRIMARY_KEY && data.hasOwnProperty(colName)) {
                                const cell = row.querySelector(`td[data-column="${colName}"]`);
                                if (cell) {
                                    cell.textContent = data[colName];
                                }
                            }
                        });
                    }

                    closeModal();
                    alert('记录更新成功');
                } else {
                    alert('更新失败: ' + (result.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('更新时发生错误');
            });
    });

    // 点击模态框外部关闭
    document.getElementById('editModal').addEventListener('click', function (event) {
        if (event.target === this) {
            closeModal();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        // 确保主题变量存在
        const root = document.documentElement;
        const theme = localStorage.getItem('theme') || 'light';
        
        // 设置默认主题变量
        const setThemeVariables = () => {
            if (theme === 'dark') {
                root.style.setProperty('--text-color', '#e2e8f0');
                root.style.setProperty('--surface-color', '#1e293b');
                root.style.setProperty('--card-border-color', '#334155');
            } else {
                root.style.setProperty('--text-color', '#333333');
                root.style.setProperty('--surface-color', '#ffffff');
                root.style.setProperty('--card-border-color', '#ddd');
            }
        };
        
        setThemeVariables();
        
        // 监听主题变化
        window.addEventListener('themeChanged', setThemeVariables);
        
        // 确保模态框内容可访问
        const modal = document.getElementById('editModal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });
        }
    });
</script>
{% endblock %}