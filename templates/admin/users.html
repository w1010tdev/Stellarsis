{% extends "base.html" %}
{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}
{% block head %}
    <title>ç”¨æˆ·ç®¡ç† - ç¤¾äº¤å¹³å°</title>
{% endblock %}
{% block content %}
    {% if session.import_failed %}
    <div class="alert alert-warning">
        <strong>éƒ¨åˆ†ç”¨æˆ·å¯¼å…¥å¤±è´¥ï¼š</strong>
        <ul>
        {% for item in session.import_failed %}
            <li>{{ item.username }}ï¼š{{ item.reason }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    <div class="admin-container">
        <h1>ç”¨æˆ·ç®¡ç†</h1>
        <div class="user-actions">
            <button class="btn btn-add" onclick="showCreateUserModal()">åˆ›å»ºç”¨æˆ·</button>
            <form id="importUsersForm" action="{{ url_for('admin_import_users') }}" method="post" enctype="multipart/form-data" style="display:inline-block;margin-left:16px;">
                <input type="file" name="file" accept=".csv" required style="display:inline-block;">
                <button type="submit" class="btn btn-secondary">æ‰¹é‡å¯¼å…¥ç”¨æˆ·</button>
            </form>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ·åã€æ˜µç§°...">
            <button class="btn" onclick="searchUsers()">æœç´¢</button>
            <button class="btn btn-secondary" onclick="clearSearch()">æ¸…é™¤</button>
        </div>
        <table class="admin-table user-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ç”¨æˆ·å</th>
                    <th>æ˜µç§°</th>
                    <th>è§’è‰²</th>
                    <th>æœ€åæ´»åŠ¨</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                {% for user in users %}
                <tr id="user-row-{{ user.id }}">
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.nickname or user.username }}</td>
                    <td>
                        <span class="role-badge role-{{ user.role }}">{{ user.role }}</span>
                    </td>
                    <td>{{ user.last_seen.strftime('%Y-%m-%d %H:%M:%S') if user.last_seen else 'ä»æœª' }}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-permission" onclick='openPermissionModal({{ user.id }}, {{ user.username|tojson }}, {{ user.role|tojson }})'>åˆ†åŒºæƒé™</button>
                        {% if user.id != 1 %}
                            {% if user.role == 'user' %}
                                <button class="btn btn-make-admin" onclick="changeUserRole({{ user.id }}, 'admin')">è®¾ä¸ºç®¡ç†å‘˜</button>
                            {% else %}
                                <button class="btn btn-make-user" onclick="changeUserRole({{ user.id }}, 'user')">è®¾ä¸ºç”¨æˆ·</button>
                            {% endif %}
                            <button class="btn btn-delete" onclick="deleteUser({{ user.id }}, '{{ user.username }}')">åˆ é™¤</button>
                        {% else %}
                            <span class="default-info">ç³»ç»Ÿç®¡ç†å‘˜</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- æƒé™ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal-backdrop" id="permissionModal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h3 class="modal-title" id="permissionModalTitle">åˆ†åŒºæƒé™</h3>
                <button class="modal-close" onclick="closePermissionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="permissionRoleTip" class="permission-tip"></p>
                <div class="permission-section">
                    <h4>èŠå¤©å®¤æƒé™</h4>
                    <table class="permission-table">
                        <thead>
                            <tr>
                                <th>åç§°</th>
                                <th>ç®€ä»‹</th>
                                <th>æƒé™</th>
                            </tr>
                        </thead>
                        <tbody id="chatPermissionBody">
                            <tr><td colspan="3" class="loading">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="permission-section">
                    <h4>è´´å§åˆ†åŒºæƒé™</h4>
                    <table class="permission-table">
                        <thead>
                            <tr>
                                <th>åç§°</th>
                                <th>ç®€ä»‹</th>
                                <th>æƒé™</th>
                            </tr>
                        </thead>
                        <tbody id="forumPermissionBody">
                            <tr><td colspan="3" class="loading">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePermissionModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    <!-- åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal-backdrop" id="createUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">åˆ›å»ºæ–°ç”¨æˆ·</h3>
                <button class="modal-close" onclick="closeCreateUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-group">
                        <label for="newUsername">ç”¨æˆ·å:</label>
                        <input type="text" id="newUsername" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">å¯†ç :</label>
                        <input type="password" id="newPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="newNickname">æ˜µç§°:</label>
                        <input type="text" id="newNickname" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="newColor">åå­—é¢œè‰²:</label>
                        <input type="text" id="newColor" class="form-control" value="#000000" placeholder="#RRGGBB">
                        <div class="color-preview" id="new-color-preview"></div>
                    </div>
                    <div class="form-group">
                        <label for="newBadge">å¾½ç« :</label>
                        <input type="text" id="newBadge" class="form-control" placeholder="å¦‚: VIP, MOD">
                    </div>
                    <div class="form-group">
                        <label for="newRole">è§’è‰²:</label>
                        <select id="newRole" class="form-control">
                            <option value="user">ç”¨æˆ·</option>
                            <option value="admin">ç®¡ç†å‘˜</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateUserModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="submitCreateUserForm()">åˆ›å»ºç”¨æˆ·</button>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script>
        // æ¨¡æ€æ¡†æ˜¾ç¤º/éšè—
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        function escapeHtml(str) {
            if (str === undefined || str === null) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        const PERMISSION_OPTIONS = [
            { value: 'su', label: 'su - å®Œå…¨æ§åˆ¶' },
            { value: '777', label: '777 - å¯å‘è¨€å¹¶åˆ é™¤è‡ªå·±çš„å†…å®¹' },
            { value: '444', label: '444 - ä»…æŸ¥çœ‹' },
            { value: 'Null', label: 'Null - ä¸å¯è§' }
        ];
        let permissionModalState = { userId: null, role: 'user' };
        
        // é¢œè‰²é¢„è§ˆ
        document.addEventListener('DOMContentLoaded', function() {
            const colorInput = document.getElementById('newColor');
            const colorPreview = document.getElementById('new-color-preview');
            
            if (colorInput && colorPreview) {
                colorPreview.style.backgroundColor = colorInput.value;
                colorInput.addEventListener('input', function() {
                    colorPreview.style.backgroundColor = colorInput.value;
                });
            }
        });
        
        // æœç´¢åŠŸèƒ½
        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#userTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // æ¸…é™¤æœç´¢
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            const rows = document.querySelectorAll('#userTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // ç›‘å¬å›è½¦é”®æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUsers();
            }
        });
        
        // æ›´æ”¹ç”¨æˆ·è§’è‰²
        async function changeUserRole(userId, newRole) {
            if (!(await showConfirm(`ç¡®å®šè¦å°†ç”¨æˆ·è§’è‰²æ›´æ”¹ä¸º ${newRole} å—ï¼Ÿ`))) {
                return;
            }
            fetch(`/api/admin/users/${userId}/role`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    role: newRole
                })
            })
            .then(response => response.json())
            .then(data => {
                    if (data.success) {
                    // æ›´æ–°é¡µé¢ä¸Šçš„è§’è‰²æ˜¾ç¤º
                    const row = document.getElementById(`user-row-${userId}`);
                    const roleCell = row.querySelector('td:nth-child(4)');
                    const actionCell = row.querySelector('td:nth-child(6)');
                    
                    // æ›´æ–°è§’è‰²å¾½ç« 
                    roleCell.innerHTML = `<span class="role-badge role-${newRole}">${newRole}</span>`;
                    
                    // æ›´æ–°æ“ä½œæŒ‰é’®
                    let newButton = '';
                    if (userId === 1) {
                        newButton = '<span class="default-info">ç³»ç»Ÿç®¡ç†å‘˜</span>';
                    } else {
                        if (newRole === 'user') {
                            newButton = `<button class="btn btn-make-admin" onclick="changeUserRole(${userId}, 'admin')">è®¾ä¸ºç®¡ç†å‘˜</button>`;
                        } else {
                            newButton = `<button class="btn btn-make-user" onclick="changeUserRole(${userId}, 'user')">è®¾ä¸ºç”¨æˆ·</button>`;
                        }
                        newButton += `<button class="btn btn-delete" onclick="deleteUser(${userId}, '')">åˆ é™¤</button>`;
                    }
                    actionCell.innerHTML = newButton;
                    showToast('success', data.message);
                    // æ›¿æ¢å¯èƒ½å‡ºç°åœ¨ç”¨æˆ·å/æŒ‰é’®æ–‡æœ¬ä¸­çš„ Emoji
                    replaceEmojisInElement(row);
                } else {
                    showToast('error', 'æ“ä½œå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                showToast('error', 'æ“ä½œå¤±è´¥: ' + error.message);
            });
        }
        
        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId, username) {
            if (!username) {
                // å¦‚æœæ²¡æœ‰ä¼ å…¥ç”¨æˆ·åï¼Œä»DOMä¸­è·å–
                const row = document.querySelector(`#user-row-${userId}`);
                username = row.querySelector('td:nth-child(2)').textContent;
            }
            if (!(await showConfirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`))) {
                return;
            }
            fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`user-row-${userId}`).remove();
                    showToast('success', data.message);
                } else {
                    showToast('error', 'åˆ é™¤å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                showToast('error', 'åˆ é™¤å¤±è´¥: ' + error.message);
            });
        }
        
        // æ˜¾ç¤ºåˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡†
        function showCreateUserModal() {
            showModal('createUserModal');
        }
        
        // å…³é—­åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡†
        function closeCreateUserModal() {
            hideModal('createUserModal');
            document.getElementById('createUserForm').reset();
            document.getElementById('new-color-preview').style.backgroundColor = '#000000';
        }
        
        // åˆ›å»ºç”¨æˆ·
        function submitCreateUserForm() {
            const userData = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                nickname: document.getElementById('newNickname').value,
                color: document.getElementById('newColor').value || '#000000',
                badge: document.getElementById('newBadge').value,
                role: document.getElementById('newRole').value
            };
            
            fetch('/api/admin/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message);
                    closeCreateUserModal();
                    // é‡æ–°åŠ è½½é¡µé¢ä»¥æ˜¾ç¤ºæ–°ç”¨æˆ·
                    location.reload();
                } else {
                    showToast('error', 'åˆ›å»ºå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                showToast('error', 'åˆ›å»ºå¤±è´¥: ' + error.message);
            });
        }
        
        function renderLoadingState(targetId) {
            const body = document.getElementById(targetId);
            if (body) {
                body.innerHTML = '<tr><td colspan="3" class="loading">åŠ è½½ä¸­...</td></tr>';
            }
        }
        
        function renderPermissionTable(targetId, entries, scope) {
            const tbody = document.getElementById(targetId);
            if (!tbody) return;
            if (!entries || !entries.length) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty">æš‚æ— æ•°æ®</td></tr>';
                return;
            }
            const isAdmin = permissionModalState.role === 'admin';
            tbody.innerHTML = entries.map(item => {
                const current = item.perm || 'Null';
                const options = PERMISSION_OPTIONS.map(opt => {
                    const selected = opt.value.toLowerCase() === current.toLowerCase() ? 'selected' : '';
                    return `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
                }).join('');
                return `
                    <tr>
                        <td>${escapeHtml(item.name)}</td>
                        <td>${escapeHtml(item.description || '--')}</td>
                        <td>
                            <select class="permission-select" data-scope="${scope}" data-target="${item.id}" data-current="${current}" ${isAdmin ? 'disabled' : ''}>
                                ${options}
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
            if (!isAdmin) {
                tbody.querySelectorAll('.permission-select').forEach(select => {
                    select.addEventListener('change', handlePermissionChange);
                });
            }
            // æ›¿æ¢è¡¨æ ¼å†…çš„ Emoji ä¸º FontAwesome å›¾æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            replaceEmojisInElement(tbody);
        }
        
        function handlePermissionChange(event) {
            try {
                const select = event.target;
                const previous = select.dataset.current || select.value;
                // åŸºæœ¬éªŒè¯
                const scope = select.dataset.scope;
                const target = select.dataset.target;
                if (!scope || typeof target === 'undefined') {
                    showToast('error', 'æƒé™ä¿¡æ¯ç¼ºå¤±ï¼Œæ— æ³•æ›´æ–°');
                    return;
                }
                select.disabled = true;
                fetch(`/api/admin/users/${permissionModalState.userId}/permissions`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        scope: scope,
                        target_id: Number(target),
                        perm: select.value
                    })
                })
                .then(response => {
                    // å°è¯•å®‰å…¨è§£æJSON
                    return response.json().catch(() => ({ success: false, message: 'æœåŠ¡å™¨è¿”å›æ ¼å¼ä¸æ­£ç¡®' }));
                })
                .then(data => {
                    if (data && data.success) {
                        select.dataset.current = select.value;
                        showToast('success', 'æƒé™å·²æ›´æ–°');
                    } else {
                        select.value = previous;
                        showToast('error', data && data.message ? data.message : 'æƒé™æ›´æ–°å¤±è´¥');
                    }
                })
                .catch(error => {
                    select.value = previous;
                    showToast('error', error && error.message ? error.message : 'æƒé™æ›´æ–°å¤±è´¥');
                })
                .finally(() => {
                    select.disabled = false;
                });
            } catch (e) {
                console.error('å¤„ç†æƒé™å˜æ›´æ—¶å‘ç”Ÿé”™è¯¯:', e);
                showToast('error', 'å†…éƒ¨é”™è¯¯ï¼šæ— æ³•æ›´æ–°æƒé™');
            }
        }
        
        function openPermissionModal(userId, username, role) {
            permissionModalState = { userId, role };
            const title = document.getElementById('permissionModalTitle');
            if (title) {
                title.textContent = `åˆ†åŒºæƒé™ - ${username}`;
            }
            const tip = document.getElementById('permissionRoleTip');
            if (tip) {
                tip.textContent = role === 'admin'
                    ? 'ç®¡ç†å‘˜è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰åˆ†åŒº su æƒé™ï¼Œæ­¤å¤„ä»…ä¾›æŸ¥çœ‹ã€‚'
                    : 'ä¸ºè¯¥ç”¨æˆ·é…ç½® su / 777 / 444 / Null æƒé™ã€‚';
            }
            renderLoadingState('chatPermissionBody');
            renderLoadingState('forumPermissionBody');
            showModal('permissionModal');
            
            fetch(`/api/admin/users/${userId}/permissions`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderPermissionTable('chatPermissionBody', data.chat, 'chat');
                        renderPermissionTable('forumPermissionBody', data.forum, 'forum');
                    } else {
                        throw new Error(data.message || 'åŠ è½½æƒé™å¤±è´¥');
                    }
                })
                .catch(error => {
                    const message = error.message || 'åŠ è½½æƒé™å¤±è´¥';
                    const chatBody = document.getElementById('chatPermissionBody');
                    const forumBody = document.getElementById('forumPermissionBody');
                    if (chatBody) chatBody.innerHTML = `<tr><td colspan="3" class="empty">${message}</td></tr>`;
                    if (forumBody) forumBody.innerHTML = `<tr><td colspan="3" class="empty">${message}</td></tr>`;
                    showToast('error', message);
                });
        }
        
        function closePermissionModal() {
            hideModal('permissionModal');
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(event) {
            const createModal = document.getElementById('createUserModal');
            if (event.target === createModal) {
                closeCreateUserModal();
            }
            const permModal = document.getElementById('permissionModal');
            if (event.target === permModal) {
                closePermissionModal();
            }
        });

        // Emoji -> FontAwesome æ›¿æ¢æ˜ å°„ä¸è¿è¡Œæ—¶æ›¿æ¢å‡½æ•°
        const EMOJI_FA_MAP = {
            'ğŸ˜€': 'fa-smile', 'ğŸ˜ƒ': 'fa-smile', 'ğŸ˜„': 'fa-smile', 'ğŸ˜': 'fa-grin',
            'ğŸ˜‚': 'fa-laugh', 'ğŸ˜Š': 'fa-smile-beam', 'ğŸ˜': 'fa-heart', 'ğŸ˜…': 'fa-smile',
            'ğŸ‘': 'fa-thumbs-up', 'ğŸ”¥': 'fa-fire', 'ğŸ‰': 'fa-star', 'ğŸ˜': 'fa-grin-stars',
            'ğŸ¤”': 'fa-question', 'ğŸ˜¢': 'fa-sad-tear'
        };

        function replaceEmojisInElement(root) {
            if (!root) return;
            const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false);
            const textNodes = [];
            while (walker.nextNode()) textNodes.push(walker.currentNode);
            textNodes.forEach(textNode => {
                const parent = textNode.parentNode;
                if (!parent) return;
                let text = textNode.nodeValue;
                let changed = false;
                Object.keys(EMOJI_FA_MAP).forEach(emoji => {
                    if (text && text.includes(emoji)) {
                        const faClass = EMOJI_FA_MAP[emoji];
                        const parts = text.split(emoji);
                        const frag = document.createDocumentFragment();
                        for (let i = 0; i < parts.length; i++) {
                            if (parts[i].length) frag.appendChild(document.createTextNode(parts[i]));
                            if (i < parts.length - 1) {
                                const iEl = document.createElement('i');
                                iEl.className = `fa ${faClass}`;
                                frag.appendChild(iEl);
                            }
                        }
                        parent.replaceChild(frag, textNode);
                        changed = true;
                    }
                });
            });
        }

        // åœ¨ DOM å°±ç»ªæ—¶å¯¹å·²æœ‰å†…å®¹æ‰§è¡Œä¸€æ¬¡æ›¿æ¢
        document.addEventListener('DOMContentLoaded', function() {
            replaceEmojisInElement(document.body);
        });
    </script>
{% endblock %}