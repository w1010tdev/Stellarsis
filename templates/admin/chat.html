{% extends "base.html" %}
{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}
{% block head %}
    <title>聊天管理 - 社交平台</title>
{% endblock %}
{% block content %}
    <div class="admin-container">
        <h1>聊天管理</h1>
        <div class="post-actions">
            <button class="btn btn-add" onclick="showCreateRoomModal()">创建聊天室</button>
            <button class="btn delete-btn" onclick="clearChatMessages()">清空所有聊天消息</button>
            <button class="btn delete-btn" onclick="clearChatRoomMessages()">清空特定聊天室消息</button>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="搜索聊天室名称...">
            <button class="btn" onclick="searchRooms()">搜索</button>
            <button class="btn btn-secondary" onclick="clearSearch()">清除</button>
        </div>
        <table class="admin-table chat-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>名称</th>
                    <th>描述</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="chatTableBody">
                {% for room in rooms %}
                <tr id="room-row-{{ room.id }}">
                    <td>{{ room.id }}</td>
                    <td>{{ room.name }}</td>
                    <td>{{ room.description or '无描述' }}</td>
                    <td class="action-buttons">
                        {% if room.id != 1 %}
                            <button class="btn btn-edit" onclick="editRoom({{ room.id }}, '{{ room.name|e }}', '{{ room.description|e }}')">编辑</button>
                            <button class="btn delete-btn" onclick="deleteRoom({{ room.id }}, '{{ room.name|e }}')">删除</button>
                        {% else %}
                            <span class="default-info">默认聊天室</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- 创建房间模态框 -->
    <div class="modal-backdrop" id="createRoomModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">创建聊天室</h3>
                <button class="modal-close" onclick="closeCreateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createRoomForm">
                    <div class="form-group">
                        <label for="createRoomName">名称:</label>
                        <input type="text" id="createRoomName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="createRoomDescription">描述:</label>
                        <textarea id="createRoomDescription" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateModal()">取消</button>
                <button class="btn btn-primary" onclick="submitCreateRoomForm()">创建</button>
            </div>
        </div>
    </div>
    <!-- 编辑房间模态框 -->
    <div class="modal-backdrop" id="editRoomModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">编辑聊天室</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editRoomForm">
                    <input type="hidden" id="editRoomId" value="">
                    <div class="form-group">
                        <label for="editRoomName">名称:</label>
                        <input type="text" id="editRoomName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editRoomDescription">描述:</label>
                        <textarea id="editRoomDescription" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">取消</button>
                <button class="btn btn-primary" onclick="submitEditRoomForm()">保存</button>
            </div>
        </div>
    </div>
    <!-- 清空特定聊天室消息模态框 -->
    <div class="modal-backdrop" id="clearRoomModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">清空聊天室消息</h3>
                <button class="modal-close" onclick="closeClearRoomModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="selectRoom">选择聊天室:</label>
                    <select id="selectRoom" class="form-control">
                        <option value="">所有聊天室</option>
                        {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="beforeDate">清空日期前的消息:</label>
                    <input type="date" id="beforeDate" class="form-control">
                    <small class="help-text">留空则清空所有消息</small>
                </div>
            </div>
                <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeClearRoomModal()">取消</button>
                <button class="btn delete-btn" onclick="confirmClearRoomMessages()">清空消息</button>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script>
        // 模态框显示/隐藏
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        // 搜索功能
        function searchRooms() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#chatTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // 清除搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            const rows = document.querySelectorAll('#chatTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // 监听回车键搜索
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchRooms();
            }
        });
        
        // 显示创建房间模态框
        function showCreateRoomModal() {
            document.getElementById('createRoomName').value = '';
            document.getElementById('createRoomDescription').value = '';
            showModal('createRoomModal');
        }
        
        // 关闭创建模态框
        function closeCreateModal() {
            hideModal('createRoomModal');
        }
        
        // 编辑房间
        function editRoom(roomId, name, description) {
            document.getElementById('editRoomId').value = roomId;
            document.getElementById('editRoomName').value = name;
            document.getElementById('editRoomDescription').value = description || '';
            showModal('editRoomModal');
        }
        
        // 删除房间
        async function deleteRoom(roomId, roomName) {
            if (!(await showConfirm(`确定要删除聊天室 "${roomName}" 吗？此操作不可撤销！`, {danger: true}))) {
                return;
            }
            fetch(`/api/admin/chat/rooms/${roomId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`room-row-${roomId}`).remove();
                    showToast('success', data.message);
                } else {
                    showToast('error', '删除失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                showToast('error', '删除失败: ' + error.message);
            });
        }
        
        // 关闭模态框
        function closeModal() {
            hideModal('editRoomModal');
        }
        
        function closeClearRoomModal() {
            hideModal('clearRoomModal');
        }
        
        // 保存房间修改
        function submitEditRoomForm() {
            const roomId = document.getElementById('editRoomId').value;
            const name = document.getElementById('editRoomName').value;
            const description = document.getElementById('editRoomDescription').value;
            
            fetch(`/api/admin/chat/rooms/${roomId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新页面上的房间信息
                    const row = document.getElementById(`room-row-${roomId}`);
                    row.cells[1].textContent = name;
                    row.cells[2].textContent = description || '无描述';
                    closeModal();
                    showToast('success', data.message);
                } else {
                    showToast('error', '操作失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                showToast('error', '操作失败: ' + error.message);
            });
        }
        
        // 创建房间
        function submitCreateRoomForm() {
            const name = document.getElementById('createRoomName').value;
            const description = document.getElementById('createRoomDescription').value;
            
            fetch('/api/admin/chat/rooms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 添加新房间到表格
                    const newRow = document.createElement('tr');
                    newRow.id = `room-row-${data.room.id}`;
                    newRow.innerHTML = `
                        <td>${data.room.id}</td>
                        <td>${data.room.name}</td>
                        <td>${data.room.description || '无描述'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-edit" onclick="editRoom(${data.room.id}, '${data.room.name.replace(/'/g, "\\'")}', '${(data.room.description || '').replace(/'/g, "\\'")}')">编辑</button>
                            <button class="btn delete-btn" onclick="deleteRoom(${data.room.id}, '${data.room.name.replace(/'/g, "\\'")}')">删除</button>
                        </td>
                    `;
                    document.getElementById('chatTableBody').appendChild(newRow);
                    closeCreateModal();
                    showToast('success', data.message);
                } else {
                    showToast('error', '操作失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                showToast('error', '操作失败: ' + error.message);
            });
        }
        
        // 清空所有聊天消息
        async function clearChatMessages() {
            if (!(await showConfirm('确定要清空所有聊天消息吗？此操作不可撤销！', {danger: true}))) {
                return;
            }
            fetch('/api/admin/chat/messages', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message);
                } else {
                    showToast('error', '清空失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                showToast('error', '清空失败: ' + error.message);
            });
        }
        
        // 清空特定聊天室消息
        function clearChatRoomMessages() {
            showModal('clearRoomModal');
        }
        
        // 确认清空特定聊天室消息
        async function confirmClearRoomMessages() {
            const roomId = document.getElementById('selectRoom').value;
            const beforeDate = document.getElementById('beforeDate').value;
            let url = '/api/admin/chat/messages';
            const params = [];
            if (roomId) params.push(`room_id=${roomId}`);
            if (beforeDate) params.push(`before=${beforeDate}T23:59:59`);
            if (params.length > 0) url += '?' + params.join('&');
            
            if (!(await showConfirm('确定要清空选定条件下的聊天消息吗？此操作不可撤销！', {danger: true}))) {
                return;
            }
            
            fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeClearRoomModal();
                    showToast('success', data.message);
                } else {
                    showToast('error', '清空失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                showToast('error', '清空失败: ' + error.message);
            });
        }
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            const createModal = document.getElementById('createRoomModal');
            const editModal = document.getElementById('editRoomModal');
            const clearModal = document.getElementById('clearRoomModal');
            
            if (event.target === createModal) {
                closeCreateModal();
            }
            if (event.target === editModal) {
                closeModal();
            }
            if (event.target === clearModal) {
                closeClearRoomModal();
            }
        });
    </script>
{% endblock %}